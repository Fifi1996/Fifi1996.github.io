---
title: 理解TCP/IP协议三次握手四次挥手
date: 2017-06-25 15:56:22
tags:
categories: 计算机网络
---
---
之前学了计算机网络，但半年后就忘的差不多了，感觉TCP/IP协议的这个知识点很重要，整理一篇文章来巩固一下。文章分为TCP的概念，TCP/UDP区别总结，三次握手四次挥手的过程，为什么要这么做的原因等四大部分来讲解。
# 一 、 TCP协议的概念
TCP（transmission control protocal,传输控制协议）,是面向连接的并具备顺序控制、重发控制等机制的。所以它可以为应用提供可靠传输。工作在网络OSI的七层模型的第四层——传输层。ip在第三层——网络层。我们要知道数据从应用层发下来，会在每一层加上响应的头部信息，进行封装然后再发送到数据的接收端。每一层的作用和对应的协议如下：

![](http://upload-images.jianshu.io/upload_images/4975863-4c845a1d5dde27b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
接下来介绍TCP协议的数据格式和头部格式每个字段的含义：

![](http://upload-images.jianshu.io/upload_images/4975863-5e3c927649d3560b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
* Source Port和Destination Port:分别占用16位，表示源端口号和目的端口号；用于区别主机中的不同进程，而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一的确定一个TCP连接。
* Sequence Number:用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据字节在数据流中的序号；主要用来解决网络报乱序的问题。
* Acknowledgment Number:32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应当是上次已成功收到数据字节序号加1。不过，只有当标志位中的``ACK``标志（下面介绍）为1时该确认序列号的字段才有效。主要用来解决不丢包的问题。
* Offset:给出首部中32 bit字的数目，需要这个值是因为任选字段的长度是可变的。这个字段占4bit（最多能表示15个32bit的的字，即4*15=60个字节的首部长度），因此TCP最多有60字节的首部。然而，没有任选字段，正常的长度是20字节。
* TCP Flags:TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次为``URG``，``ACK``，``PSH``，``RST``，``SYN``，``FIN``。每个标志位的意思如下：
      * URG：此标志表示TCP包的紧急指针域（后面马上就要说到）有效，用来保证TCP连接不被中断，并且督促中间层设备要尽快处理这些数据
      * ACK：此标志表示应答域有效，就是说前面所说的TCP应答号将会包含在TCP数据包中；有两个取值：0和1，为1的时候表示应答域有效，反之为0
      * PSH：这个标志位表示Push操作。所谓Push操作就是指在数据包到达接收端以后，立即传送给应用程序，而不是在缓冲区中排队
      * RST：这个标志表示连接复位请求。用来复位那些产生错误的连接，也被用来拒绝错误和非法的数据包
      * SYN：表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1，ACK=0；连接被响应的时候，SYN=1，ACK=1；这个标志的数据包经常被用来进行端口扫描。扫描者发送一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口；但是由于这种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全的主机将会强制要求一个连接严格的进行TCP的三次握手
      * FIN： 表示发送端已经达到数据末尾，也就是说双方的数据传送完成，没有数据可以传送了，发送FIN标志位的TCP数据包后，连接将被断开。这个标志的数据包也经常被用于进行端口扫描
* Window:窗口大小，也就是有名的滑动窗口，用来进行流量控制。

___

# 二、 TCP/UDP区别总结
TCP(Transmission Control Protocol)
UDP(User Datagram Protocol)
* TCP面向连接（如打电话要先拨号建立连接)，UDP是无连接的，即发送数据之前不需要建立连接。
* TCP提供可靠的服务,逻辑通信信道是全双工的可靠信道，也就是说通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达。UDP是不可靠信道尽最大努力交付，即不保证可靠交付。
* TCP面向字节流，实际上是TCP把数据看成一连串无结构的字节流。UDP是面向报文的UDP没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低（对实时应用很有用，如IP电话，实时视频会议等）。
* 每一条TCP连接只能是点到点的,UDP支持一对一，一对多，多对一和多对多的交互通信。
* TCP首部开销20字节，UDP的首部开销小，只有8个字节。
___

# 三 、 三次握手四次挥手的过程
TCP是面向连接的，无论哪一方向另一方发送数据之前，都必须先在双方之间建立一条连接。

![](http://upload-images.jianshu.io/upload_images/4975863-20268f12043b2024.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
*  第一次握手：建立连接。客户端发送连接请求报文段，将``SYN``位置为1，``Sequence Number``为x；然后，客户端进入``SYN_SEND``状态，等待服务器的确认。
* 第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置``Acknowledgment Number``为x+1(Sequence Number+1)；同时，自己自己还要发送SYN请求信息，将SYN位置为1，``Sequence Number``为y；服务器端将上述所有信息放到一个报文段（即SYN+ACK报文段）中，一并发送给客户端，此时服务器进入``SYN_RECV``状态
* 第三次握手：客户端收到服务器的SYN+ACK报文段。然后将``Acknowledgment Number``设置为y+1，向服务器发送``ACK``报文段，这个报文段发送完毕以后，客户端和服务器端都进入``ESTABLISHED``状态，完成TCP三次握手。

完成了三次握手，客户端和服务器端就可以开始传送数据。

___

当客户端和服务器通过三次握手建立了TCP连接以后，当数据传送完毕，要断开TCP连接.对于TCP的断开连接，这里就有了神秘的“四次分手”。
* 第一次分手：主机1（可以使客户端，也可以是服务器端），设置``Sequence Number``和``Acknowledgment Number``，向主机2发送一个FIN报文段；此时，主机1进入``FIN_WAIT_1``状态；这表示主机1没有数据要发送给主机2了。
* 第二次分手：主机2收到了主机1发送的FIN报文段，向主机1回一个``ACK``报文段，``Acknowledgment Number``为``Sequence Number``加1；主机1进入``FIN_WAIT_2``状态；主机2告诉主机1，我“同意”你的关闭请求。
* 第三次分手：主机2向主机1发送``FIN``报文段，请求关闭连接，同时主机2进入``LAST_ACK``状态。
* 第四次分手：主机1收到主机2发送的``FIN``报文段，向主机2发送``ACK``报文段，然后主机1进入``TIME_WAIT``状态；主机2收到主机1的``ACK``报文段以后，就关闭连接；此时，主机1等待``2MSL``后依然没有收到回复，则证明Server端已正常关闭，主机1也可以关闭连接了。

___

# 四、 相关问题
* 1 为什么要三次握手？
感觉两次就能完成连接，为什么非要三次呢？引用谢希仁的《计算机网络》中的解释
 >  为了防止已失效的连接请求报文段突然又传送到了服务器端，因而产生错误。

   就是防止服务器端的一直等待而浪费了资源。
* 2 为什么要四次分手？
TCP协议是一种面向连接的、可靠的、基于字节流的运输层通信协议。TCP是全双工模式，这就意味着，当主机1发出FIN报文段时，只是表示主机1已经没有数据要发送了，主机1告诉主机2，它的数据已经全部发送完毕了；但是，这个时候主机1还是可以接受来自主机2的数据；当主机2返回``ACK``报文段时，表示它已经知道主机1没有数据发送了，但是主机2还是可以发送数据到主机1的；当主机2也发送了FIN报文段时，这个时候就表示主机2也没有数据要发送了，就会告诉主机1，我也没有数据要发送了，之后彼此就会愉快的中断这次TCP连接。
* 3 为什么``TIME_WAIT``状态还需要等``2MSL``后才能返回到``CLOSED``状态？
 *  什么是``2MSL``？MSL即Maximum Segment Lifetime，也就是报文最大生存时间，引用《TCP/IP详解》中的话：“它(MSL)是任何报文段被丢弃前在网络内的最长时间。”那么，2MSL也就是这个时间的2倍。其实我觉得没必要把这个MSL的确切含义搞明白，你所需要明白的是，当TCP连接完成四个报文段的交换时，主动关闭的一方将继续等待一定时间(2-4分钟)，即使两端的应用程序结束。
 *  从以上TCP连接关闭的状态转换图可以看出，主动关闭的一方在发送完对对方FIN报文的确认(ACK)报文后，会进入``TIME_WAIT``状态。``TIME_WAIT``状态也称为2MSL状态。
 *   为什么需要2MSL？根据《TCP/IP详解》和《The TCP/IP Guide》中的说法，有两个原因：
 > 其一，保证发送的ACK会成功发送到对方，如何保证？我觉得可能是通过超时计时器发送。这个就很难用代码演示了。

  >   其二，报文可能会被混淆，意思是说，其他时候的连接可能会被当作本次的连接。直接引用《The TCP/IP Guide》的说法：The second is to provide a “buffering period” between the end of this connection and any subsequent ones. If not for this period, it is possible that packets from different connections could be mixed, creating confusion.
* 4 常见的应用中有哪些是应用TCP协议的，哪些又是应用UDP协议的，为什么它们被如此设计？
 * 多播的信息一定要用UDP实现，因为TCP只支持一对一通信。
 * 如果一个应用场景重性能甚于重完整性和安全性，那么适合于UDP，比如多媒体应用，缺一两帧不影响用户体验，但是需要流媒体到达的速度快，因此比较适合用UDP。
* 以qq为例的一个说明
 * 登陆采用TCP协议和HTTP协议，你和好友之间发送消息，主要采用UDP协议，内网传文件采用了P2P技术。
 * 和好友发消息，客户端client采用UDP协议，但是需要通过服务器转发。腾讯为了确保传输消息的可靠，采用上层协议来保证可靠传输。如果消息发送失败，客户端会提示消息发送失败，并可重新发送。 
 * 如果是在内网里面的两个客户端传文件，QQ采用的是P2P技术，不需要服务器中转。

![](http://upload-images.jianshu.io/upload_images/4975863-ad39340c34e20930.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)




## 参考文献
http://blog.csdn.net/yipiankongbai/article/details/24435977
http://www.jellythink.com/archives/705
http://www.zhihu.com/question/20292749
谢希仁《计算机网络》《图解tcp/ip》《tcp/ip详解》